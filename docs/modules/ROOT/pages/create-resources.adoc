= Cr√©er des ressources Azure
Etn Mn
:description: Cr√©ation de ressources dans Azure.
:navtitle: Cr√©er des ressources

L'objectif est de cr√©er un _resource group_ contenant un _storage account_.

.Architecture cible
excalidraw::partial$diagrams/create-resources.excalidraw[svg]

== Azure Provider

Le https://registry.terraform.io/providers/hashicorp/azurerm[_Provider Azure_] permet de g√©rer les infrastructures _Azure_ en utilisant l'API _ARM_. Le bloc `required_providers` permet, quant √† lui, de forcer les versions utilis√©es.

.main.tf
[,terraform]
----
include::example$create-resources/main.tf[]
----

<.> Bloc de configuration _Terraform_
<.> Version minimale de _Terraform_ √† utiliser
<.> Cl√© d'identification locale du provider _AzureRM_
<.> Source du provider
<.> https://www.terraform.io/language/providers/requirements#version-constraints[Contrainte de la version du provider]
<.> Bloc de configuration du provider

IMPORTANT: Pour une question de performance, il est pr√©f√©rable de travailler depuis le r√©pertoire *HOME* de la distribution.

== Resources

Les *Resources* sont des √©l√©ments importants du langage _Terraform_. Chaque bloc d√©crit un objet de l'infrastructure : une machine virtuelle, un _storage account_, ou un https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/resource_group[resource group].

.resource-group.tf
[,terraform]
----
include::example$create-resources/resource-group.tf[lines=1..3;8]
----

<.> _Data source_ permettant de g√©rer les _resource groups_
<.> Nom local de la ressource, utilis√© pour les <<Attributs, r√©f√©rences>> dans le module _Terraform_
<.> Nom de la ressource dans _Azure_
<.> Emplacement de la ressource _Azure_

.Initialisation des providers
 $ terraform init

.Contenu du r√©pertoire projet apr√®s l'init
[listing]
----
üìí workshop-terraform
  üìÑ .terraform.lock.hcl <.>
  üìÑ resource-group.tf
  üìÑ main.tf
  üìÇ .terraform
    üìÇ providers <.>
----

<.> Fichier cr√©√© lors de l'init pour verrouiller les versions des d√©pendances utilis√©es
<.> Contient les providers t√©l√©charg√©s

.G√©n√©ration du plan d'ex√©cution (~preview)
 $ terraform plan

.D√©tail du plan d'ex√©cution
[,bash]
----
Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following
symbols:
  + create

Terraform will perform the following actions:

  # azurerm_resource_group.t-resource-group will be created
  + resource "azurerm_resource_group" "t-resource-group" { # <.>
      + id       = (known after apply)
      + location = "westeurope"
      + name     = "rg-workshop"
    }

Plan: 1 to add, 0 to change, 0 to destroy.
----

<.> Ressource cr√©√©e (symbole +) si le plan est appliqu√©

.Mise en application du plan
 $ terraform apply

[,bash]
----
Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only 'yes' will be accepted to approve.

  Enter a value: yes # <.>

azurerm_resource_group.t-resource-group: Creating...
azurerm_resource_group.t-resource-group: Creation complete after 1s [id=/subscriptions/.../resourceGroups/rg-workshop] # <.>
----

<.> Validation de la cr√©ation de la ressource
<.> Le _resource group_ a √©t√© cr√©√© dans la _subscription_

A l'issue de la commande _apply_, un fichier xref:terraform-intro.adoc#state[state]: `terraform.tfstate` est cr√©√© dans le r√©pertoire du projet. Lorsque des *modifications* sont apport√©es √† une ressource g√©r√©e par _Terraform_, deux cas sont possibles:

. Les modifications peuvent √™tre appliqu√©es directement √† la ressource
. Les modifications n√©cessitent de red√©ployer la ressource. C'est le cas par exemple lorsque l'on souhaite modifier la redondance d'un _storage account_

Pour ajouter un _tag_ au _resource group_ :

.resource-group.tf
[,terraform]
----
include::example$create-resources/resource-group.tf[]
----

<.> _Data source_ permettant de g√©rer les _resource groups_
<.> Nom local de la ressource, utilis√© pour r√©f√©rencer dans le module _Terraform_
<.> Nom de la ressource dans _Azure_
<.> Emplacement de la ressource _Azure_
<.> Ajout du _tag_ `environnement`

.Mise √† jour du plan d'ex√©cution
 $ terraform plan

[,bash]
----
azurerm_resource_group.t-resource-group: Refreshing state... [id=/subscriptions/.../resourceGroups/rg-workshop]

Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following
symbols:
  ~ update in-place

Terraform will perform the following actions:

  # azurerm_resource_group.t-resource-group will be updated in-place
  ~ resource "azurerm_resource_group" "t-resource-group" { # <.>
        id       = "/subscriptions/.../resourceGroups/rg-workshop"
        name     = "rg-workshop"
      ~ tags     = {
          + "environment" = "dev"
        }
        # (1 unchanged attribute hidden)
    }

Plan: 0 to add, 1 to change, 0 to destroy.
----

<.> Ressource modifi√©e (symbole ~)

√Ä partir des informations contenues dans le fichier `terraform.tfstate`, _Terraform_ a d√©termin√© que seul le _tag_ devait √™tre cr√©√©.

.Ajout du tag dans Azure
 $ terraform apply

.Voir l'√©tat du d√©ploiement dans Azure
 $ terraform show

.Indenter automatiquement les fichier .tf du r√©pertoire
 $ terraform fmt

== Sauvegarder le plan

lors de l'utilisation de la commande `terraform plan`, il est conseill√© de https://www.terraform.io/cli/commands/plan[sauvegarder] le plan afin de s'assurer que l' `apply` soit coh√©rent avec ce qui a √©t√© observ√© lors de la planification.

 Note: You didn't use the -out option to save this plan, so Terraform can't guarantee to take exactly
 these actions if you run "terraform apply" now.

.Sauvegarde du plan et cr√©ation du fichier binaire `tfplan`
 $ terraform plan -out=tfplan

.Application du plan
 $ terraform apply tfplan

NOTE: Lorsque que l'on applique un plan sauvegard√©, aucune confirmation de modification de ressource n'est demand√©e.

== Les variables

L'utilisation des https://www.terraform.io/language/values/variables[variables] permet de s√©parer la configuration du code. La configuration peur changer en fonction des environnements cibles, elle doit donc √™tre stock√©e √† l'ext√©rieur de l'application.

.variables.tf
[,terraform]
----
include::example$create-resources/variables.tf[lines=1..10]
----

<.> La d√©claration des variables se fait dans les blocs `variable`. La nom doit √™tre unique et respecter les contraintes des https://www.terraform.io/language/syntax/configuration#identifiers[Identifiers]
<.> Si le `type` n'est pas sp√©cifi√©, la valeur par d√©faut sera `string`
<.> Une valeur par d√©faut peut parfois √™tre utile quand on utilise fr√©quemment les m√™mes valeurs. https://github.com/claranet/terraform-azurerm-regions/blob/master/REGIONS.md[Liste des r√©gions Azure] (_Colonne Azure CLI Name_)

Pour faire r√©f√©rence aux variables, on utilise la syntaxe: `var.nom-de-la-variable`

.resource-group.tf
[,terraform]
----
include::example$create-resources/resource-group-var.tf[]
----

<.> Utilisation des variables du fichier _variables.tf_

Lors du _plan_, les variables sans valeur par d√©faut devront √™tre renseign√©es.

== Passer les variables √† Terraform

Renseigner manuellement les variables lors du _plan_ est source d'erreurs. Il existe 3 autres possibilit√©s:

=== L'option -var

.Assignation de la variable via la ligne de commande
 $ terraform plan -var.resource-group-name="rg-workshop"

=== Variable d'environnement

Utile lorsque l'on utilise souvent les m√™mes variables. Le nom de la variable d'environnement doit √™tre pr√©fix√© par `TF_VAR_`

.Assignation de la variable via la ligne de commande
 $ export TF_VAR_resource-group-name='rg-workshop'

=== Fichiers de d√©finition des variables

Les fichiers de d√©finition des variables listent les variables et leurs valeurs. Ces fichiers portent l'extension `.tfvars` ou `.tfvars.json`.

.terraform.tfvars
----
include::example$create-resources/terraform.tfvars[]
----

IMPORTANT: Il est pr√©f√©rable d'xref:setup.adoc#git[exclure] ces fichiers du _repository_.

== Attributs

Les attributs d'une xref:create-resources.adoc#resources[ressource] sont ses valeurs post d√©ploiement, par exemple son nom. Il est possible de faire r√©f√©rence √† ces informations lors de la configuration grace aux https://www.terraform.io/language/expressions[expressions], la syntaxe est alors: `<RESOURCE TYPE>.<TERRAFORM_NAME>.<ATTRIBUTE>`. On pourra ainsi utiliser le nom du _resource group_ cr√©√© pr√©c√©demment de la mani√®re suivante: `azurerm_resource_group.t-rg-workshop.name`

Dans l'exemple qui suit, on cr√©√© un compte de stockage √† partir des attributs du _resource group_.

.variables.tf
----
include::example$create-resources/variables.tf[lines=12..-1]
----

.storage-account.tf
----
include::example$create-resources/storage-account.tf[]
----
<.> https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/storage_account[Ajout d'un compte de stockage]
<.> Utilisation de l'attribut _nom_ du _resource group_
<.> Utilisation de l'attribut _localisation_ du _resource group_
<.> https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/storage_container[Ajout d'un conteneur]
<.> Utilisation de l'attribut _nom_ du compte de stockage

== Nettoyer les ressources

L'option `-destroy` permet de supprimer les ressources g√©r√©es par _Terraform_.

.Planifier puis supprimer les ressources
 $ terraform plan -destroy
 $ terraform apply -destroy

NOTE: il est √©galement possible d'utiliser l'alias `terraform destroy`
