= Les modules
Etn Mn
:description: CrÃ©ation de packages autonomes de configuration.

Les modules _Terraform_ sont des abstractions autonomes de la configuration, permettant d'organiser son code et de le rÃ©utiliser. Un module est une collection de fichiers `.tf`, rassemblÃ©s dans un mÃªme rÃ©pertoire. Toutes les configurations disposent d'au *moins un module*, appelÃ© _root_ et constituÃ© des fichiers `.tf` prÃ©sents dans le rÃ©pertoire principal. Les modules peuvent peuvent appeler des modules enfants, afin d'inclure leurs ressources dans la configuration. Les modules enfants peuvent Ãªtre appelÃ©s plusieurs fois dans une mÃªme configuration et plusieurs configurations peuvent appeler les mÃªmes modules.

Les modules peuvent Ãªtre chargÃ©s depuis les fichiers locaux, mais Ã©galement depuis un _registry_ privÃ© ou https://registry.terraform.io/browse/modules[public].

== Structure d'un module

.Exemple de structure d'un module
[listing]
----
ğŸ“’ my-module
  ğŸ“„ LICENSE
  ğŸ“„ README.md
  ğŸ“„ main.tf
  ğŸ“„ variables.tf
  ğŸ“„ outputs.tf
----

Il est possible de crÃ©er un module avec seulement un seul fichier `.tf` mais il est important de ne pas distribuer les fichiers suivants :

* `terraform.tfstate`, `terraform.tfstate.backup`: _state_ terraform
* `.terraform`: contient les plugins
* `*.tfvars`: variables

== Outputs

Les _Outputs_ sont les xref:ROOT:create-resources.adoc#les-variables[variables] de sortie d'un module. Elles ont plusieurs cas d'utilisations :

* Un module enfant peut utiliser les _outputs_ pour exposer des attributs de ses ressources Ã  son module parent
* Le module racine peut utiliser les _outputs_ pour afficher des informations dans la _CLI_, Ã  l'issue du `terraform apply`
* Dans le cas des dÃ©pÃ´ts distants, une configuration peut accÃ©der aux _outputs_ d'un module _root_ d'une autre configuration via le xref:existing-resources#data-source[data source] `terraform_remote_state`. Il est ainsi possible de partager de l'information entre les configurations.

Pour dÃ©finir une variable de sortie, on utilise le mot clÃ© `output` :

.output.tf
[,terraform]
----
output "azurerm_storage_account_name" {
  value       = azurerm_storage_account.storage-blob.name # <.>
  description = "The Azure Blob storage account name."
}
----

<.> Le nom du _storage account_ est exposÃ© via la variable `azurerm_storage_account_name`

Pour faire rÃ©fÃ©rence Ã  un variable de sortie, il faut utiliser la syntaxe: `module.<nom-du-module>.<nom-output>`

.main.tf
[,terraform]
----
module "application" {
  source           = "./modules/app-service"
  resource_group   = azurerm_resource_group.main.name
  application_name = var.application_name
  environment      = local.environment
  location         = var.location

  azure_storage_account_name  = module.storage-blob.azurerm_storage_account_name # <.>
}

module "storage-blob" { # <.>
  source           = "./modules/storage-blob" # <.>
  resource_group   = azurerm_resource_group.main.name
  application_name = var.application_name
  environment      = local.environment
  location         = var.location
}
----

<.> Nom du module cible
<.> Chemin relatif du module
<.> RÃ©cupÃ©ration de la valeur de la variable de sortie

== TÃ©lÃ©chargement depuis GitHub

Un module peut Ãªtre tÃ©lÃ©chargÃ© depuis une _repo GitHub_

.Via protocole HTTPS
[,terraform]
----
module "mon_module" {
    source = "github.com/hajdaini/example"
}
----

.Via protocole SSH
[,terraform]
----
module "mon_module" {
    source = "git@github.com:hajdaini/example.git"
}
----
